<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Search - Enhanced Location Flow</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .search-container { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; align-items: end; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .suggestions { border: 1px solid #ddd; max-height: 200px; overflow-y: auto; display: none; position: relative; z-index: 1000; }
        .suggestion { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; background: white; }
        .suggestion:hover { background: #f5f5f5; }
        .vendor-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .vendor-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .vendor-name { font-size: 1.2em; font-weight: bold; color: #333; }
        .vendor-rating { color: #ffc107; }
        .distance-info { background: #e8f5e8; padding: 8px; border-radius: 4px; margin: 10px 0; }
        .distance { color: #28a745; font-weight: bold; }
        .loading { text-align: center; padding: 20px; }
        .no-results { text-align: center; padding: 40px; color: #6c757d; }
        .search-info { background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .filter-chip { background: #e9ecef; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; }
        .current-location-btn { background: #28a745; margin-left: 10px; }
    </style>
</head>
<body>
    <h1>üß∫ Find Laundry Vendors Near You</h1>
    
    <div class="search-container">
        <h3>üìç Set Your Location</h3>
        
        <div class="form-row">
            <div class="form-group">
                <label for="address">Enter Your Address:</label>
                <input type="text" id="address" placeholder="Start typing your address..." autocomplete="off">
                <div id="suggestions" class="suggestions"></div>
            </div>
            <div class="form-group">
                <button onclick="getCurrentLocation()" class="current-location-btn">üì± Use Current Location</button>
            </div>
        </div>

        <div id="coordinates-display" style="display: none;">
            <div class="form-group">
                <label>Selected Location:</label>
                <input type="text" id="coordinates" readonly>
            </div>
        </div>

        <h3>üîç Search Filters</h3>
        
        <div class="form-row">
            <div class="form-group">
                <label for="serviceId">Service Type:</label>
                <select id="serviceId">
                    <option value="">All Services</option>
                    <option value="507f1f77bcf86cd799439011">Wash & Fold</option>
                    <option value="507f1f77bcf86cd799439012">Dry Cleaning</option>
                    <option value="507f1f77bcf86cd799439013">Express Wash</option>
                </select>
            </div>
            <div class="form-group">
                <label for="radius">Search Radius:</label>
                <select id="radius">
                    <option value="5">5 km</option>
                    <option value="10" selected>10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="50">50 km</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sortBy">Sort By:</label>
                <select id="sortBy">
                    <option value="distance">Distance</option>
                    <option value="rating">Rating</option>
                    <option value="name">Name</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>
                    <input type="checkbox" id="includeDistance" checked> Include detailed distance calculations
                </label>
            </div>
            <div class="form-group">
                <button onclick="searchVendors()" id="searchBtn">üîç Search Vendors</button>
            </div>
        </div>
    </div>

    <div id="searchInfo" class="search-info" style="display: none;"></div>
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:3000/api/v1';
        let selectedLocation = null;
        let debounceTimer = null;

        // Address autocomplete
        document.getElementById('address').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 3) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchAddressSuggestions(query);
            }, 300);
        });

        async function fetchAddressSuggestions(query) {
            try {
                const response = await fetch(`${API_BASE}/location/autocomplete?query=${encodeURIComponent(query)}&country=GH`);
                const data = await response.json();
                
                const suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = '';
                
                if (data.predictions && data.predictions.length > 0) {
                    data.predictions.forEach(prediction => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.innerHTML = `
                            <strong>${prediction.mainText}</strong><br>
                            <small>${prediction.secondaryText}</small>
                        `;
                        div.onclick = () => selectAddress(prediction);
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }

        async function selectAddress(prediction) {
            document.getElementById('address').value = prediction.description;
            document.getElementById('suggestions').style.display = 'none';
            
            selectedLocation = {
                placeId: prediction.placeId,
                address: prediction.description,
                coordinates: prediction.coordinates
            };
            
            if (prediction.coordinates) {
                document.getElementById('coordinates').value = 
                    `${prediction.coordinates[1].toFixed(6)}, ${prediction.coordinates[0].toFixed(6)}`;
                document.getElementById('coordinates-display').style.display = 'block';
            }
        }

        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'üìç Getting location...';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    selectedLocation = {
                        latitude: lat,
                        longitude: lng
                    };
                    
                    document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    document.getElementById('coordinates-display').style.display = 'block';
                    document.getElementById('address').value = 'Current Location';
                    
                    btn.disabled = false;
                    btn.textContent = 'üì± Use Current Location';
                },
                (error) => {
                    alert('Error getting location: ' + error.message);
                    btn.disabled = false;
                    btn.textContent = 'üì± Use Current Location';
                }
            );
        }

        async function searchVendors() {
            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const searchInfoDiv = document.getElementById('searchInfo');
            
            searchBtn.disabled = true;
            searchBtn.textContent = 'üîç Searching...';
            resultsDiv.innerHTML = '<div class="loading">üîç Searching for vendors...</div>';

            try {
                const params = new URLSearchParams();
                
                // Add location parameters
                if (selectedLocation) {
                    if (selectedLocation.latitude && selectedLocation.longitude) {
                        params.append('latitude', selectedLocation.latitude);
                        params.append('longitude', selectedLocation.longitude);
                    } else if (selectedLocation.placeId) {
                        params.append('placeId', selectedLocation.placeId);
                    } else if (selectedLocation.address) {
                        params.append('address', selectedLocation.address);
                    }
                }
                
                // Add filter parameters
                const serviceId = document.getElementById('serviceId').value;
                if (serviceId) params.append('serviceId', serviceId);
                
                params.append('radius', document.getElementById('radius').value);
                params.append('sortBy', document.getElementById('sortBy').value);
                params.append('includeDistance', document.getElementById('includeDistance').checked);

                const response = await fetch(`${API_BASE}/vendors/search?${params.toString()}`);
                const data = await response.json();
                
                displaySearchResults(data);
                
            } catch (error) {
                console.error('Error searching vendors:', error);
                resultsDiv.innerHTML = '<div class="no-results">‚ùå Error searching vendors. Please try again.</div>';
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'üîç Search Vendors';
            }
        }

        function displaySearchResults(data) {
            const resultsDiv = document.getElementById('results');
            const searchInfoDiv = document.getElementById('searchInfo');
            
            // Display search info
            if (data.searchCriteria) {
                const filters = [];
                if (data.searchCriteria.serviceId) filters.push('Service filtered');
                if (data.searchCriteria.radius) filters.push(`${data.searchCriteria.radius}km radius`);
                filters.push(`Sorted by ${data.searchCriteria.sortBy}`);
                
                searchInfoDiv.innerHTML = `
                    <strong>Search Results:</strong> ${data.total} vendor(s) found
                    <div class="filters">
                        ${filters.map(f => `<span class="filter-chip">${f}</span>`).join('')}
                    </div>
                `;
                searchInfoDiv.style.display = 'block';
            }

            if (data.vendors && data.vendors.length > 0) {
                let html = '';
                
                data.vendors.forEach(vendor => {
                    html += `
                        <div class="vendor-card">
                            <div class="vendor-header">
                                <div class="vendor-name">${vendor.name}</div>
                                <div class="vendor-rating">‚≠ê ${vendor.rating || 'N/A'}/5 (${vendor.reviewCount || 0} reviews)</div>
                            </div>
                            
                            <p><strong>üìç Address:</strong> ${vendor.address?.street || 'N/A'}, ${vendor.address?.city || 'N/A'}</p>
                            <p><strong>üìû Phone:</strong> ${vendor.phone || 'N/A'}</p>
                            
                            ${vendor.distance ? `
                                <div class="distance-info">
                                    <span class="distance">üìç ${vendor.distanceText || vendor.distance.toFixed(1) + ' km'}</span>
                                    ${vendor.durationText ? ` ‚Ä¢ üöó ${vendor.durationText}` : ''}
                                    <small> (${vendor.distanceStatus})</small>
                                </div>
                            ` : ''}
                            
                            ${vendor.operatingHours ? `
                                <p><strong>üïí Hours:</strong> ${vendor.operatingHours.monday || 'N/A'}</p>
                            ` : ''}
                            
                            <button onclick="selectVendor('${vendor.id || vendor._id}')">üìã Select This Vendor</button>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            } else {
                let html = '<div class="no-results">üòî No vendors found';
                
                if (data.message) {
                    html += `<p>${data.message}</p>`;
                }
                
                if (data.suggestions && data.suggestions.length > 0) {
                    html += '<p><strong>Suggestions:</strong></p><ul>';
                    data.suggestions.forEach(suggestion => {
                        html += `<li>${suggestion}</li>`;
                    });
                    html += '</ul>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
            }
        }

        function selectVendor(vendorId) {
            alert(`Selected vendor: ${vendorId}\nThis would typically navigate to the order creation page.`);
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#address') && !e.target.closest('#suggestions')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });
    </script>
</body>
</html>
